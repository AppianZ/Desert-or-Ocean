<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="screen-orientation" content="portrait">
    <title>日期选择器</title>
    <style>
        @font-face {
            font-family: 'iconfont';
            src: url("//at.alicdn.com/t/font_1463738657_1735377.eot");
            /* IE9*/
            src: url("//at.alicdn.com/t/font_1463738657_1735377.eot?#iefix") format("embedded-opentype"), url("//at.alicdn.com/t/font_1463738657_1735377.woff") format("woff"), url("//at.alicdn.com/t/font_1463738657_1735377.ttf") format("truetype"), url("//at.alicdn.com/t/font_1463738657_1735377.svg#iconfont") format("svg");
            /* iOS 4.1- */ }
        .iconfont {
            font-family: 'iconfont';
            color: white; }
        * {
            padding: 0;
            margin: 0; }
        body {
            background: #f2f2f2; }
        .container {
            width: 100%;
            height: 250px;
            position: absolute;
            bottom: 0;
            left: 0;
            background-color: #FFF;
            transition: all .2s; }
        .btn-box {
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-justify-content: space-between;
            -ms-flex-pack: justify;
            justify-content: space-between;
            height: 50px;
            line-height: 50px;
            background: #abcdef; }
        .btn-box .btn {
            margin: 0 20px; }
        .content.date {
            font-size: 0; }
        .content.date .date-selector {
            display: inline-block;
            width: 33.3%;
            height: 200px;
            overflow: hidden; }
        .content.date ul::-webkit-scrollbar {
            display: none; }
        .content.date li {
            height: 40px;
            text-align: center;
            font-size: 16px;
            line-height: 40px;
            list-style: none; }
        .content.date .up-shadow, .content.date .down-shadow {
            width: 100%;
            height: 80px;
            position: absolute;
            pointer-events: none;
            background-image: linear-gradient(to bottom, #FFF, rgba(255, 255, 255, 0)); }
        .content.date .up-shadow {
            top: 50px; }
        .content.date .down-shadow {
            bottom: 0;
            background-image: linear-gradient(to top, #FFF, rgba(255, 255, 255, 0)); }
        .content.date .line {
            width: 95%;
            height: 40px;
            position: absolute;
            top: 130px;
            left: 50%;
            pointer-events: none;
            box-sizing: border-box;
            border-top: 1px solid #DCDCDC;
            border-bottom: 1px solid #DCDCDC;
            -webkit-transform: translate(-50%, 0);
            transform: translate(-50%, 0); }
    </style>
</head>
<body>
<div class="container">
    <div class="btn-box">
        <div class="btn">返回</div>
        <div class="btn save">提交</div>
    </div>
    <div class="content date">
        <div class="date-selector">
            <ul id="year"></ul>
        </div>
        <div class="date-selector">
            <ul id="month"></ul>
        </div>
        <div class="date-selector">
            <ul id="date"></ul>
        </div>
        <div class="up-shadow"></div>
        <div class="down-shadow"></div>
        <div class="line"></div>
    </div>
</div>

<script>
    /**
     * Created by JW on 2016/5/27.
     */
    var yearArr = [],monthArr = [],dateArr=[];
    var liHeight = 40;
    var maxHeight = [];
    var yearUl = document.getElementById('year');
    var monthUl = document.getElementById('month');
    var dateUl = document.getElementById('date');
    var count = 100;//设置年份多少年
    var currentYear = new Date().getFullYear();//实际年份
    var resultArr = [currentYear - count + 1,1,1];
    window.onload = function () {
        initArr.initYear(currentYear,count);
        initArr.initMonth();
        initArr.initDate(currentYear,1);
        daySelector.readyLoad();
    };
    var initArr = (function(){
        return {
            'initArr' : function (arr,ul) {
                var Html = '';
                arr.unshift(' ',' ');
                arr.push(' ',' ');
                for(var i = 0; i< arr.length ; i++){
                    Html += '<li>' + arr[i] + '</li>';
                }
                ul.innerHTML = Html;
                return this;
            },
            'initYear' : function(current,count){
                var year = 0;
                while (year < count) {
                    yearArr.unshift(current - year);
                    year++;
                }
                this.initArr(yearArr,yearUl);
                maxHeight[0] = liHeight * (count - 1);
            },
            'initMonth' : function(){
                var month = 0;
                while (month < 12) {
                    monthArr.push(month + 1);
                    month++;
                }
                this.initArr(monthArr,monthUl);
                maxHeight[1] = liHeight * 11;
            },
            'initDate' : function (year,month){//传入真实年份和月份
                var date = 0;
                var sum = new Date(year,month,0).getDate();
                var sub = 0;
                if(sum < resultArr[2]){
                    sub = sum - dateArr[dateArr.indexOf(resultArr[2])];
                    if(sub < 0){
                        var y = dateUl.style.transform.split(',')[1].replace('px','');
                        dateUl.style.transform = 'translate3d(0,' + (y - sub * liHeight) + 'px, 0)';
                        dateUl.style.transition = 'all 0.15s ease-out';
                        resultArr[2] = -( y / liHeight ) + sub + 1;
                    }
                }
                dateArr　= [];
                while (date < sum) {
                    dateArr.push(date + 1);
                    date++;
                }
                this.initArr(dateArr,dateUl);
                maxHeight[2] = liHeight * (sum - 1);
            }
        }
    })();
    var daySelector = (function(){
        return {
            start: { //所有跟touchstart有关的参数
                Y : 0,
                time : ''
            } ,
            move : { //所有跟touchmove有关的参数
                Y : 0,
                speed : []
            },
            end : { //所有跟touchmove有关的参数
                Y : 0,
                index : 0
            },
            distance : [0,0,0],
            initListener : function(ul,array,typeIdx){
                var _this = this;
                ul.addEventListener('touchstart',function(){
                    _this.touch(event,_this,ul,array,typeIdx);
                }, false);
                ul.addEventListener('touchmove',function(){
                    _this.touch(event,_this,ul,array,typeIdx);
                }, false);
                ul.addEventListener('touchend',function(){
                    _this.touch(event,_this,ul,array,typeIdx);
                }, false);
            },
            readyLoad : function(){
                this.initListener(yearUl,yearArr,0);
                this.initListener(monthUl,monthArr,1);
                this.initListener(dateUl,dateArr,2);
            },
            initPosition: function(dis,max,idx){  //位置格式化
                dis = dis < 0 ? 0 : dis;
                dis = dis > max ? max : dis;
                var sub =  dis % liHeight;
                if(sub < liHeight/2){
                    this.distance[idx] = dis - sub ;
                }else {
                    this.distance[idx] = dis + (liHeight - sub) ;
                }
                return this;
            },
            initSpeed : function (arr,dir,max,idx) { //速度Arr格式化
                var variance = 0;
                var sum = 0;
                for(var i in arr){
                    sum += arr[i] - 0;
                }
                for(var j in arr){
                    variance += (arr[j]-(sum/arr.length)) * (arr[j]-(sum/arr.length));
                }
                console.log('方差:' + (variance/arr.length).toFixed(2));
                var rate = 0;
                if((variance/arr.length).toFixed(2) > .1){ //可根据速度变化来调节滑动状态！！！
                    rate = max > liHeight * 35 ? dir * 2 : 0;
                    this.initPosition(this.distance[idx] + rate, max,idx);
                    this.move.speed[0] = .3;
                }else {
                    this.initPosition(this.distance[idx],max,idx);
                    this.move.speed[0] = this.move.speed[0] > 0.3 ? .3 : this.move.speed[0];
                }
                return this;
            },
            touch : function(event,that,$selector,arrry,typeIdx){
                event = event || window.event;
                switch(event.type) {
                    case "touchstart":
                        that.move.speed = [];
                        that.start.Y = event.touches[0].clientY;
                        that.start.time = Date.now();
                        break;
                    case "touchend":
                        that.end.Y = event.changedTouches[0].clientY;
                        var tempDis = that.distance[typeIdx] + (that.start.Y - that.end.Y);
                        that.distance[typeIdx] = tempDis < 0 ? 0 : (tempDis < maxHeight[typeIdx] ? tempDis : maxHeight[typeIdx]);
                        console.log(that.move.speed);
                        this.initSpeed(that.move.speed,that.start.Y - that.end.Y,maxHeight[typeIdx],typeIdx);
                        $selector.style.transform = 'translate3d(0,-' +  that.distance[typeIdx] + 'px, 0)';
                        $selector.style.transition = 'all ' + that.move.speed[0] + 's ease-out';
                        that.end.index = that.distance[typeIdx]/liHeight + 2;
                        if(typeIdx == 0) {
                            resultArr[typeIdx] = arrry[that.end.index];
                            initArr.initDate(resultArr[typeIdx],resultArr[1]);
                        }else if(typeIdx == 1) {
                            resultArr[typeIdx] = arrry[that.end.index];
                            initArr.initDate(resultArr[0],resultArr[typeIdx]);
                        }else {
                            resultArr[typeIdx] = arrry[that.end.index];
                        }
                        console.log(resultArr);
                        break;
                    case "touchmove":
                        event.preventDefault();
                        that.move.Y = event.touches[0].clientY;
                        var offset = that.start.Y - that.move.Y;
                        if (that.distance[typeIdx] == 0 && offset < 0) {
                            $selector.style.transform = 'translate3d(0,' + 1.5 * liHeight + 'px, 0)';
                            $selector.style.transition = 'all 0.3s ease-out';
                        }else {
                            $selector.style.transform = 'translate3d(0,-'+ (offset + that.distance[typeIdx]) +'px, 0)';
                        }
                        if(this.distance[typeIdx] <= -maxHeight[typeIdx]){
                            $selector.style.transform = 'translate3d(0, -' + (max+liHeight) + 'px, 0)';
                            $selector.style.transition = 'all 0.3s ease-out';
                        }
                        if (Math.abs(offset) % 5 === 0) {//存储速度
                            var time = Date.now();
                            that.move.speed.push((Math.abs(offset) / (time - that.start.time)).toFixed(2));
                        }
                        break;
                }
            }
        }
    })();
</script>

</body>
</html>
